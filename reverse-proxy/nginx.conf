# ================================
# /etc/nginx/nginx.conf
# 用於 Docker (nginx:1.27-alpine)
# ================================
user  nginx;                # 只能在 main 區塊；不要放到 conf.d/*.conf
worker_processes auto;

events {
  worker_connections  1024;
}

http {
  # --- 基本設定 ---
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  # 日誌格式
  log_format  main  '$remote_addr - $host [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
  access_log  /var/log/nginx/access.log  main;
  error_log   /var/log/nginx/error.log warn;

  sendfile        on;
  tcp_nopush      on;
  tcp_nodelay     on;
  keepalive_timeout  65;

  # 可視需要啟用 gzip
  gzip on;
  gzip_types text/plain text/css application/json application/javascript application/xml;
  gzip_min_length 1024;

  # 允許上傳（依需求調整）
  client_max_body_size 50m;

  # --- Cloudflare 真實 IP ---
  real_ip_recursive on;
  set_real_ip_from 173.245.48.0/20;
  set_real_ip_from 103.21.244.0/22;
  set_real_ip_from 103.22.200.0/22;
  set_real_ip_from 103.31.4.0/22;
  set_real_ip_from 141.101.64.0/18;
  set_real_ip_from 108.162.192.0/18;
  set_real_ip_from 190.93.240.0/20;
  set_real_ip_from 188.114.96.0/20;
  set_real_ip_from 197.234.240.0/22;
  set_real_ip_from 198.41.128.0/17;
  set_real_ip_from 162.158.0.0/15;
  set_real_ip_from 104.16.0.0/12;
  set_real_ip_from 172.64.0.0/13;
  set_real_ip_from 131.0.72.0/22;
  # 若要加 IPv6，可補上 Cloudflare IPv6 段

  # --- WebSocket/HTTP1.1 代理共用變數 ---
  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }

  # --- 與 Flask 容器對接的 upstream ---
  upstream app_main {
    server app_main:8000;
    keepalive 32;
  }
  upstream app_shop {
    server app_shop:8000;
    keepalive 32;
  }
  upstream app_webprim {
    server app_web_primary:8000;
    keepalive 32;
  }

  # --- 反向代理共用參數（給各 vhost 使用） ---
  proxy_http_version 1.1;
  proxy_read_timeout  75s;
  proxy_send_timeout  75s;
  proxy_connect_timeout 15s;
  proxy_buffers 16 16k;
  proxy_buffer_size 32k;

  # 這些 header 會在各 vhost 的 location / 中設定
  # proxy_set_header Host $host;
  # proxy_set_header X-Real-IP $remote_addr;
  # proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  # proxy_set_header X-Forwarded-Proto $scheme;
  # proxy_set_header Upgrade $http_upgrade;
  # proxy_set_header Connection $connection_upgrade;

  # 載入所有站台（py-sites.com / shop / web-primary）
  include /etc/nginx/conf.d/*.conf;
}
